// buildscript can be removed once gradle-release plugin is approved by grdle
buildscript {
    repositories {
        mavenLocal()
        if (project.hasProperty('localNexus')) {
            maven {
                url "${localNexus}"
                allowInsecureProtocol = true
            }
        } else {
            mavenCentral()
        }
    }

    dependencies {
        classpath 'com.fincher:gradle-release:0.0.4-SNAPSHOT'
    }
}

plugins {
    id 'java-gradle-plugin'
    id 'maven-publish'
	id "eclipse"
    id "com.diffplug.spotless" version "6.7.2"
    id 'checkstyle'
    id 'com.gradle.plugin-publish' version '1.0.0'
}

apply plugin: 'com.fincher.release'

group = 'com.fincher'

pluginBundle {
  website = 'https://github.com/bfincher/gradle-release-plugin'
  vcsUrl = 'https://github.com/bfincher/gradle-release-plugin'
  tags = ['release']
}

gradlePlugin {
	plugins {
		release {
			id = "com.fincher.release"
            displayName = 'Gradle release plugin'
            description = 'A plugin to perform a release in 2 phases.  Allowing for a tag and publish to be performed before the new version is set'
			implementationClass = "com.fincher.gradle.release.ReleasePlugin"
		}
	}
}
java {
	toolchain {
    	languageVersion = JavaLanguageVersion.of(11)
	}
}

release {
  if (project.hasProperty('sshKeyFile')) {
    gitRepositorySshPrivateKeyFile = file("${sshKeyFile}")
  }
  
  // temporary.  remove this
  requiredBranchRegex = 'publish'
}

/*
tasks.named("finalizeRelease") {
    def taskOutput = StringBuilder()
    logging.addStandardOutputListener { taskOutput.append(it) }
    doLast {
        // Usage of taskOutput must be in doLast, after all other task actions have been done.
        // Be careful: if there's another `doLast {}` added after this, the output from that won't be considered.
        if ("warning:" in taskOutput) {
            throw Exception(
                """
                There was a problem executing foo, please fix.
                """.trimIndent()
            )
        }
    }
}
*/

sourceSets {
	functionalTest {
		java {
			compileClasspath += main.output
			runtimeClasspath += main.output
		}
	}
}

repositories {
    mavenLocal()
    if (project.hasProperty('localNexus')) {
        maven {
            url "${localNexus}"
        }
    } else {
        mavenCentral()
    }
}

publishing {
    repositories {
        maven {
            if (project.hasProperty("publishUsername") && project.hasProperty("publishPassword")) { 
                credentials {
                    username = "${publishUsername}"
                    password = "${publishPassword}"
                }
		
                if (project.version.endsWith('-SNAPSHOT')) {
                    url "${publishSnapshotUrl}"
                } else {
                    url "${publishReleaseUrl}"
                }

                authentication {
                    basic(BasicAuthentication)
                }
            }
        }
    }
}
	
configurations.functionalTestImplementation.extendsFrom(configurations.testImplementation)

dependencies {
    implementation 'org.eclipse.jgit:org.eclipse.jgit:6.2.0.202206071550-r'
    implementation 'org.eclipse.jgit:org.eclipse.jgit.ssh.jsch:6.2.0.202206071550-r'
    implementation 'com.google.guava:guava:31.1-jre'
    testImplementation 'org.junit.jupiter:junit-jupiter-api:5.8.1'
    testImplementation 'org.junit.jupiter:junit-jupiter:5.8.1'
    testImplementation 'org.mockito:mockito-core:4.6.1'
    implementation 'com.google.guava:guava:31.1-jre'
    functionalTestImplementation 'com.google.guava:guava:31.1-jre'
}

// Add a task to run the functional tests
tasks.register('functionalTest', Test) {
   	testClassesDirs = sourceSets.functionalTest.output.classesDirs
   	classpath = sourceSets.functionalTest.runtimeClasspath
   	useJUnitPlatform()
}

gradlePlugin.testSourceSets(sourceSets.functionalTest)

tasks.named('check') {
   	// Run the functional tests as part of `check`
   	dependsOn(tasks.functionalTest)
}

tasks.named('test') {
   	useJUnitPlatform()
}

spotless {
    java {
        eclipse('4.19.0').configFile('config/eclipse_format.xml')
    }
}
